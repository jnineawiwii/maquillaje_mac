{% extends "base.html" %}

{% block content %}
<section class="cart-container">
    <h1>Tu Carrito de Compras</h1>
    
    {% if cart_items %}
    <div class="cart-items">
        {% for item in cart_items %}
        <div class="cart-item-card" data-product-id="{{ item.product.id }}" data-product-name="{{ item.product.name }}">
            <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" onerror="this.src='https://via.placeholder.com/180x180/e0e0e0/666666?text=Imagen'">
            <div class="cart-item-info">
                <h3>{{ item.product.name }}</h3>
                <p class="price">${{ "%.2f"|format(item.product.price) }}</p>
                <div class="quantity-controls">
                    <button class="quantity-btn" data-action="decrease" data-product-id="{{ item.product.id }}">-</button>
                    <span class="quantity">{{ item.quantity }}</span>
                    <button class="quantity-btn" data-action="increase" data-product-id="{{ item.product.id }}">+</button>
                </div>
                <p class="item-total">Total: ${{ "%.2f"|format(item.total) }}</p>
                <button class="remove-item" data-product-id="{{ item.product.id }}">Eliminar</button>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="cart-summary">
        <h2>Total: ${{ "%.2f"|format(total) }}</h2>
        <a href="{{ url_for('checkout') }}" class="btn-primary">Proceder al pago</a>
    </div>
    {% else %}
    <div class="empty-cart">
        <p>Tu carrito está vacío</p>
        <a href="{{ url_for('products') }}" class="btn-primary">Seguir comprando</a>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Agregar event listeners a todos los botones de eliminar
        const removeButtons = document.querySelectorAll('.remove-item');
        removeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const productId = this.getAttribute('data-product-id');
                removeItemFromCart(productId);
            });
        });
        
        function removeItemFromCart(productId) {
            fetch('/remove_from_cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: parseInt(productId) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const itemToRemove = document.querySelector(`.cart-item-card[data-product-id="${productId}"]`);
                    if (itemToRemove) itemToRemove.remove();
                    if (data.total !== undefined) document.querySelector('.cart-summary h2').textContent = `Total: $${data.total.toFixed(2)}`;
                    if (document.querySelectorAll('.cart-item-card').length === 0) {
                        document.querySelector('.cart-items').innerHTML = `
                            <div class="empty-cart">
                                <p>Tu carrito está vacío</p>
                                <a href="{{ url_for('products') }}" class="btn-primary">Seguir comprando</a>
                            </div>`;
                        document.querySelector('.cart-summary').style.display = 'none';
                    }
                    showNotification('Producto eliminado del carrito');
                } else {
                    showNotification('Error: ' + data.message, true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error al eliminar el producto', true);
            });
        }
        
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.backgroundColor = isError ? '#e74c3c' : '#27ae60';
            notification.style.color = 'white';
            notification.style.padding = '12px 20px';
            notification.style.borderRadius = '4px';
            notification.style.zIndex = '1000';
            notification.style.boxShadow = '0 3px 10px rgba(0, 0, 0, 0.2)';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        
        const quantityButtons = document.querySelectorAll('.quantity-btn');
        quantityButtons.forEach(button => {
            button.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                const productId = this.getAttribute('data-product-id');
                const quantityElement = this.parentElement.querySelector('.quantity');
                let quantity = parseInt(quantityElement.textContent);
                
                if (action === 'increase') quantity++;
                else if (action === 'decrease' && quantity > 1) quantity--;
                updateQuantity(productId, quantity, quantityElement);
            });
        });
        
        function updateQuantity(productId, quantity, quantityElement) {
            fetch('/update_cart_quantity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: parseInt(productId), quantity: quantity })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    quantityElement.textContent = quantity;
                    window.location.reload();
                } else {
                    showNotification('Error: ' + data.message, true);
                    window.location.reload();
                }
            })
            .catch(error => { console.error('Error:', error); showNotification('Error al actualizar la cantidad', true); window.location.reload(); });
        }
    });
</script>

<style>
    .cart-item-card {
        display: flex;
        flex-direction: column;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: transform 0.2s;
        margin-bottom: 20px;
    }

    .cart-item-card:hover {
        transform: translateY(-3px);
    }

    .cart-item-card img {
        width: 100%;
        height: 180px;
        object-fit: cover;
    }

    .cart-item-info {
        padding: 12px 16px;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .cart-item-info h3 {
        font-size: 1.1rem;
        margin: 0;
    }

    .cart-item-info .price {
        font-weight: 600;
        color: #7b1fa2;
    }

    .quantity-controls button {
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        margin: 0 4px;
    }

    .item-total {
        font-weight: 600;
        margin-top: 6px;
    }

    .remove-item {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 8px;
        transition: background 0.3s;
    }

    .remove-item:hover {
        background: #c0392b;
    }
</style>
{% endblock %}
